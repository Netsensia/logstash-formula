{% from "logstash/map.jinja" import logstash with context %}

# based on: http://cookbook.logstash.net/recipes/syslog-pri/
input {
    tcp {
        port => 2514
        type => syslog
    }
    udp {
        port => 2514
        type => syslog
    }
    redis {
        host => '{{logstash.redis}}'
        data_type => list
        key => 'logstash:beaver'
        type => 'logstash:beaver'
    }
}


filter {
  if [type] == "syslog" {
    # syslog preprocessing
    grok {
      pattern => [ "<%{POSINT:syslog_pri}>%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" ]
      add_field => [ "received_at", "%{@timestamp}" ]
      add_field => [ "received_from", "%{host}" ]
    }
    if [syslog_message] {
      mutate {
        replace => [ "@message", "%{syslog_message}" ]
      }
    }

    # all syslog parsers in one place
    grok {
      pattern => [
        "IPTables-Dropped: %{IPTABLES}",
        "%{HAPROXYHTTP}",
        "%{HAPROXYTCP}"
      ]
      patterns_dir => ["/etc/logstash/patterns"]
    }

    # lets split haproxy key=value pairs
    if [syslog_program] == "haproxy" {
      kv {
          source => "keyvalue"
      }
      mutate {
        replace => [ "request_id", "%{[@fields][request_id]}" ]
      }
    }
  }

  if 'audit' in [tags] {
    grok {
      patterns_dir => "/etc/logstash/patterns"
      pattern => [
        "%{AUDIT}",
        "%{AUDITLOGIN}",
        "%{AUDITOTHER}"
      ]
    }
  }

  if 'kernel' in [tags] {
    grok {
      patterns_dir => ["/etc/logstash/patterns"]
      match => [ "message", "%{APPARMOR}" ]
    }
    if '_grokparsefailure' not in [tags] {
      mutate {
        replace => ["tags", "apparmor"]
      }
    }
  }

  # TODO: consider flattening nginx logs so that we don't have @fields.xxx and i.e. we can easily filter logs
  # on request_id combining them from all different sources

}


output {
    elasticsearch_http {
        host => "{{logstash.elasticsearch.host}}"
        port => "{{logstash.elasticsearch.port}}"
    }
}
